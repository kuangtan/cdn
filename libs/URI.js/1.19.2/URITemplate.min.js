!function(e,t){"use strict";"object"==typeof module&&module.exports?module.exports=t(require("./URI")):"function"==typeof define&&define.amd?define(["./URI"],t):e.URITemplate=t(e.URI,e)}(this,function(f,e){"use strict";var t=e&&e.URITemplate,i=Object.prototype.hasOwnProperty;function u(e){return u._cache[e]?u._cache[e]:this instanceof u?(this.expression=e,u._cache[e]=this):new u(e)}function o(e){this.data=e,this.cache={}}var r=u.prototype,m={"":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encode"},"+":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},"#":{prefix:"#",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},".":{prefix:".",separator:".",named:!1,empty_name_separator:!1,encode:"encode"},"/":{prefix:"/",separator:"/",named:!1,empty_name_separator:!1,encode:"encode"},";":{prefix:";",separator:";",named:!0,empty_name_separator:!1,encode:"encode"},"?":{prefix:"?",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"},"&":{prefix:"&",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"}};return u._cache={},u.EXPRESSION_PATTERN=/\{([^a-zA-Z0-9%_]?)([^\}]+)(\}|$)/g,u.VARIABLE_PATTERN=/^([^*:.](?:\.?[^*:.])*)((\*)|:(\d+))?$/,u.VARIABLE_NAME_PATTERN=/[^a-zA-Z0-9%_.]/,u.LITERAL_PATTERN=/[<>{}"`^| \\]/,u.expand=function(e,t,r){var n,a,o,i=m[e.operator],p=i.named?"Named":"Unnamed",s=e.variables,l=[];for(o=0;a=s[o];o++){if(0===(n=t.get(a.name)).type&&r&&r.strict)throw new Error('Missing expansion value for variable "'+a.name+'"');if(n.val.length){if(1<n.type&&a.maxlength)throw new Error('Invalid expression: Prefix modifier not applicable to variable "'+a.name+'"');l.push(u["expand"+p](n,i,a.explode,a.explode&&i.separator||",",a.maxlength,a.name))}else n.type&&l.push("")}return l.length?i.prefix+l.join(i.separator):""},u.expandNamed=function(e,t,r,n,a,o){var i,p,s,l="",c=t.encode,d=t.empty_name_separator,h=!e[c].length,u=2===e.type?"":f[c](o);for(p=0,s=e.val.length;p<s;p++)a?(i=f[c](e.val[p][1].substring(0,a)),2===e.type&&(u=f[c](e.val[p][0].substring(0,a)))):h?(i=f[c](e.val[p][1]),2===e.type?(u=f[c](e.val[p][0]),e[c].push([u,i])):e[c].push([void 0,i])):(i=e[c][p][1],2===e.type&&(u=e[c][p][0])),l&&(l+=n),r?l+=u+(d||i?"=":"")+i:(p||(l+=f[c](o)+(d||i?"=":"")),2===e.type&&(l+=u+","),l+=i);return l},u.expandUnnamed=function(e,t,r,n,a){var o,i,p,s="",l=t.encode,c=t.empty_name_separator,d=!e[l].length;for(i=0,p=e.val.length;i<p;i++)a?o=f[l](e.val[i][1].substring(0,a)):d?(o=f[l](e.val[i][1]),e[l].push([2===e.type?f[l](e.val[i][0]):void 0,o])):o=e[l][i][1],s&&(s+=n),2===e.type&&(s+=a?f[l](e.val[i][0].substring(0,a)):e[l][i][0],s+=r?c||o?"=":"":","),s+=o;return s},u.noConflict=function(){return e.URITemplate===u&&(e.URITemplate=t),u},r.expand=function(e,t){var r="";this.parts&&this.parts.length||this.parse(),e instanceof o||(e=new o(e));for(var n=0,a=this.parts.length;n<a;n++)r+="string"==typeof this.parts[n]?this.parts[n]:u.expand(this.parts[n],e,t);return r},r.parse=function(){function e(e){if(e.match(s))throw new Error('Invalid Literal "'+e+'"');return e}var t,r,n,a=this.expression,o=u.EXPRESSION_PATTERN,i=u.VARIABLE_PATTERN,p=u.VARIABLE_NAME_PATTERN,s=u.LITERAL_PATTERN,l=[],c=0;for(o.lastIndex=0;;){if(null===(r=o.exec(a))){l.push(e(a.substring(c)));break}if(l.push(e(a.substring(c,r.index))),c=r.index+r[0].length,!m[r[1]])throw new Error('Unknown Operator "'+r[1]+'" in "'+r[0]+'"');if(!r[3])throw new Error('Unclosed Expression "'+r[0]+'"');for(var d=0,h=(t=r[2].split(",")).length;d<h;d++){if(null===(n=t[d].match(i)))throw new Error('Invalid Variable "'+t[d]+'" in "'+r[0]+'"');if(n[1].match(p))throw new Error('Invalid Variable Name "'+n[1]+'" in "'+r[0]+'"');t[d]={name:n[1],explode:!!n[3],maxlength:n[4]&&parseInt(n[4],10)}}if(!t.length)throw new Error('Expression Missing Variable(s) "'+r[0]+'"');l.push({expression:r[0],operator:r[1],variables:t})}return l.length||l.push(e(a)),this.parts=l,this},o.prototype.get=function(e){var t,r,n,a=this.data,o={type:0,val:[],encode:[],encodeReserved:[]};if(void 0!==this.cache[e])return this.cache[e];if(this.cache[e]=o,null==(n="[object Function]"===String(Object.prototype.toString.call(a))?a(e):"[object Function]"===String(Object.prototype.toString.call(a[e]))?a[e](e):a[e]))return o;if("[object Array]"===String(Object.prototype.toString.call(n))){for(t=0,r=n.length;t<r;t++)void 0!==n[t]&&null!==n[t]&&o.val.push([void 0,String(n[t])]);o.val.length&&(o.type=3)}else if("[object Object]"===String(Object.prototype.toString.call(n))){for(t in n)i.call(n,t)&&void 0!==n[t]&&null!==n[t]&&o.val.push([t,String(n[t])]);o.val.length&&(o.type=2)}else o.type=1,o.val.push([void 0,String(n)]);return o},f.expand=function(e,t){var r=new u(e).expand(t);return new f(r)},u});